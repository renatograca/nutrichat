# Build stage
FROM gradle:8.5-jdk21 AS builder

WORKDIR /app

# Copiar arquivos de configuração do gradle
COPY gradle/ gradle/
COPY gradlew settings.gradle build.gradle ./

# Dar permissão de execução ao gradlew
RUN chmod +x gradlew

# Copiar código fonte
COPY src/ src/

# Build do projeto (gera o fat jar)
RUN ./gradlew clean build -x test

# Runtime stage (Usando Eclipse Temurin 21)
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

# Instalar curl para o Healthcheck (Alpine não vem com ele por padrão)
RUN apk add --no-cache curl

# Copiar apenas o JAR principal do builder
# Dica: Verifique se o nome do jar é fixo ou use um padrão que ignore o "-plain.jar"
COPY --from=builder /app/build/libs/*-all.jar app.jar || COPY --from=builder /app/build/libs/*.jar app.jar

# Variáveis de ambiente (O Render sobrescreverá estas)
ENV PORT=8080

# Expose porta padrão
EXPOSE 8080

# Health check corrigido para usar a variável de porta
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:${PORT}/health || exit 1

# Executar a aplicação
CMD ["java", "-jar", "app.jar"]